import asyncio
import xml.etree.ElementTree as ET
from typing import Any
import httpx
from mcp.server.models import InitializationOptions
import mcp.types as types
from mcp.server import NotificationOptions, Server
import mcp.server.stdio


server = Server("maven_vulnerability_scanner")


def parse_pom_xml(pom_content: str) -> list[dict[str, str]]:
    try:
        root = ET.fromstring(pom_content)

        namespaces = {'maven': 'http://maven.apache.org/POM/4.0.0'}
        if root.tag.startswith('{'):
            ns = root.tag[1:root.tag.index('}')]
            namespaces['maven'] = ns

        dependencies = []

        deps = root.findall('.//maven:dependency', namespaces)
        if not deps:
            deps = root.findall('.//dependency')

        for dep in deps:
            group_id = dep.find('maven:groupId', namespaces)
            artifact_id = dep.find('maven:artifactId', namespaces)
            version = dep.find('maven:version', namespaces)

            if group_id is None:
                group_id = dep.find('groupId')
            if artifact_id is None:
                artifact_id = dep.find('artifactId')
            if version is None:
                version = dep.find('version')

            if group_id is not None and artifact_id is not None and version is not None:
                dependencies.append({
                    'groupId': group_id.text,
                    'artifactId': artifact_id.text,
                    'version': version.text
                })

        return dependencies
    except ET.ParseError as e:
        raise ValueError(f"Invalid XML format: {str(e)}")


async def check_vulnerability_osv(group_id: str, artifact_id: str, version: str) -> dict[str, Any]:
    package_name = f"{group_id}:{artifact_id}"

    async with httpx.AsyncClient(timeout=30.0) as client:
        try:
            response = await client.post(
                "https://api.osv.dev/v1/query",
                json={
                    "package": {
                        "name": package_name,
                        "ecosystem": "Maven"
                    },
                    "version": version
                }
            )

            if response.status_code == 200:
                data = response.json()
                vulnerabilities = data.get('vulns', [])

                return {
                    'groupId': group_id,
                    'artifactId': artifact_id,
                    'version': version,
                    'vulnerable': len(vulnerabilities) > 0,
                    'vulnerabilities': [
                        {
                            'id': vuln.get('id', 'N/A'),
                            'summary': vuln.get('summary', 'No summary available'),
                            'severity': vuln.get('database_specific', {}).get('severity', 'UNKNOWN'),
                            'details': vuln.get('details', ''),
                            'references': [ref.get('url') for ref in vuln.get('references', [])]
                        }
                        for vuln in vulnerabilities
                    ]
                }
            else:
                return {
                    'groupId': group_id,
                    'artifactId': artifact_id,
                    'version': version,
                    'vulnerable': False,
                    'error': f"API returned status code {response.status_code}"
                }
        except Exception as e:
            return {
                'groupId': group_id,
                'artifactId': artifact_id,
                'version': version,
                'vulnerable': False,
                'error': str(e)
            }


@server.list_tools()
async def handle_list_tools() -> list[types.Tool]:
    return [
        types.Tool(
            name="scan_pom_vulnerabilities",
            description="Scans a Maven pom.xml file content for vulnerable dependencies using the OSV database",
            inputSchema={
                "type": "object",
                "properties": {
                    "pom_content": {
                        "type": "string",
                        "description": "The complete content of the pom.xml file as a string"
                    }
                },
                "required": ["pom_content"]
            }
        )
    ]


@server.call_tool()
async def handle_call_tool(
    name: str, arguments: dict | None
) -> list[types.TextContent | types.ImageContent | types.EmbeddedResource]:
    if name != "scan_pom_vulnerabilities":
        raise ValueError(f"Unknown tool: {name}")

    if not arguments or "pom_content" not in arguments:
        raise ValueError("Missing required argument: pom_content")

    pom_content = arguments["pom_content"]

    try:
        await server.request_context.session.send_progress_notification(
            progress_token="scan_progress",
            progress=0,
            total=100
        )

        dependencies = parse_pom_xml(pom_content)

        if not dependencies:
            await server.request_context.session.send_progress_notification(
                progress_token="scan_progress",
                progress=100,
                total=100
            )
            return [
                types.TextContent(
                    type="text",
                    text="No dependencies found in the pom.xml file."
                )
            ]

        total_deps = len(dependencies)
        await server.request_context.session.send_progress_notification(
            progress_token="scan_progress",
            progress=10,
            total=100
        )

        results = []
        for idx, dep in enumerate(dependencies):
            await server.request_context.session.send_log_message(
                level="info",
                data=f"Scanning {idx + 1}/{total_deps}: {dep['groupId']}:{dep['artifactId']}:{dep['version']}"
            )

            result = await check_vulnerability_osv(
                dep['groupId'],
                dep['artifactId'],
                dep['version']
            )
            results.append(result)

            progress = 10 + int((idx + 1) / total_deps * 80)
            await server.request_context.session.send_progress_notification(
                progress_token="scan_progress",
                progress=progress,
                total=100
            )

        await server.request_context.session.send_progress_notification(
            progress_token="scan_progress",
            progress=90,
            total=100
        )

        vulnerable_count = sum(1 for r in results if r.get('vulnerable', False))

        await server.request_context.session.send_log_message(
            level="info",
            data=f"Scan complete: {vulnerable_count} vulnerable dependencies found out of {len(dependencies)}"
        )

        output = f"Scanned {len(dependencies)} dependencies\n"
        output += f"Found {vulnerable_count} vulnerable dependencies\n\n"

        if vulnerable_count > 0:
            output += "VULNERABLE DEPENDENCIES:\n"
            output += "=" * 80 + "\n\n"

            for result in results:
                if result.get('vulnerable', False):
                    output += f"Package: {result['groupId']}:{result['artifactId']}\n"
                    output += f"Version: {result['version']}\n"
                    output += f"Vulnerabilities: {len(result['vulnerabilities'])}\n\n"

                    for vuln in result['vulnerabilities']:
                        output += f"  - ID: {vuln['id']}\n"
                        output += f"    Severity: {vuln['severity']}\n"
                        output += f"    Summary: {vuln['summary']}\n"
                        if vuln['details']:
                            output += f"    Details: {vuln['details'][:200]}...\n"
                        if vuln['references']:
                            output += f"    References:\n"
                            for ref in vuln['references'][:3]:
                                output += f"      - {ref}\n"
                        output += "\n"
                    output += "-" * 80 + "\n\n"

        output += "\nSAFE DEPENDENCIES:\n"
        output += "=" * 80 + "\n"
        for result in results:
            if not result.get('vulnerable', False):
                output += f"  - {result['groupId']}:{result['artifactId']}:{result['version']}"
                if 'error' in result:
                    output += f" (Warning: {result['error']})"
                output += "\n"

        await server.request_context.session.send_progress_notification(
            progress_token="scan_progress",
            progress=100,
            total=100
        )

        return [
            types.TextContent(
                type="text",
                text=output
            )
        ]

    except ValueError as e:
        return [
            types.TextContent(
                type="text",
                text=f"Error parsing pom.xml: {str(e)}"
            )
        ]
    except Exception as e:
        return [
            types.TextContent(
                type="text",
                text=f"Error scanning dependencies: {str(e)}"
            )
        ]


async def main():
    async with mcp.server.stdio.stdio_server() as (read_stream, write_stream):
        await server.run(
            read_stream,
            write_stream,
            InitializationOptions(
                server_name="maven_vulnerability_scanner",
                server_version="1.0.0",
                capabilities=server.get_capabilities(
                    notification_options=NotificationOptions(),
                    experimental_capabilities={},
                )
            )
        )


if __name__ == "__main__":
    asyncio.run(main())
